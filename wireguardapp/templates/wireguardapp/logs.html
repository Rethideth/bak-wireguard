{% extends "wireguardapp/base.html" %}

{% block title %}WG{% endblock %}

{% block content %}


<h1>Log toku dat ve VPN serveru</h1>


<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">

        <button class="nav-link active" 
            id="nav-latesttab" 
            data-bs-toggle="tab" 
            data-bs-target="#nav-latest" 
            type="button" 
            role="tab"
            aria-controls="nav-latest" 
            aria-selected="true">Poslední</button>
        <button class="nav-link" 
            id="nav-activetab" 
            data-bs-toggle="tab" 
            data-bs-target="#nav-active" 
            type="button" 
            role="tab"
            aria-controls="nav-active" 
            aria-selected="true">Aktivní</button>

  </div>
</nav>
<div class="tab-content" id="nav-tabContent">

    <div class="tab-pane fade show active" id="nav-latest" role="tabpanel" aria-labelledby="nav-latest-tab" tabindex="0">

        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Peer</th>
                    <th>Endpoint</th>
                    <th>Latest Handshake</th>
                    <th>RX Bytes</th>
                    <th>TX Bytes</th>
                    <th>Collected At</th>
                </tr>
            </thead>
            <tbody class="table-group-divider">
                {% for snapshot in latest_snapshots %}
                    <tr>
                        <td>{{ snapshot.peer.peer_key }}</td>
                        <td>{{ snapshot.endpoint|default:"—" }}</td>
                        <td>
                            {% if snapshot.latest_handshake %}
                                {{ snapshot.latest_handshake|date:"Y-m-d H:i:s" }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>{{ snapshot.rx_bytes }}</td>
                        <td>{{ snapshot.tx_bytes }}</td>
                        <td>{{ snapshot.collected_at|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                
                {% empty %}
                <tr>
                    <td colspan="7">No snapshots available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        

    </div>


        <div class="tab-pane fade" id="nav-active" role="tabpanel" aria-labelledby="nav-active-tab" tabindex="0">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Public Key</th>
                    <th>Endpoint</th>
                    <th>Last Handshake</th>
                    <th>Download</th>
                    <th>Upload</th>
                    <th>Connected?</th>
                </tr>
                </thead>
                <tbody id="peers-table">
                </tbody>
            </table>
    </div>

</div>

<script>
    function formatBytes(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
    }

    // CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // AJAX helper
    function ajaxWithCSRF(url, data, successCallback) {
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(successCallback)
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function fetchPeers() {

        ajaxWithCSRF("{% url 'peerstate' %}",{}, function(response)
        {
            const table = document.getElementById("peers-table");
                table.innerHTML = "";

                response.peers.forEach(peer => {
                    const row = `
                        <tr>
                            <td>${peer.public_key}</td>
                            <td>${peer.endpoint}</td>
                            <td>${peer.handshake > 0 ? "Connected" : "—"}</td>
                            <td>${formatBytes(peer.rx)}</td>
                            <td>${formatBytes(peer.tx)}</td>
                            <td>
                            ${peer.connected 
                                ? '<span class="badge bg-success">Online</span>' 
                                : '<span class="badge bg-secondary">Offline</span>'}
                            </td>
                        </tr>
                    `;
                    table.innerHTML += row;
                });
    
        });
    }

// Fetch immediately
fetchPeers();

// Refresh every 5 seconds
setInterval(fetchPeers, 5000);
</script>




{% endblock %}